import React, { useEffect, useMemo, useRef, useState } from "react";

// --- Piccola utility IndexedDB (nessuna dipendenza esterna) ---
const DB_NAME = "milano-arch-audioguida-db";
const DB_VERSION = 1;
const AUDIO_STORE = "audioBlobs";

function openDB() {
  return new Promise<IDBDatabase>((resolve, reject) => {
    const req = indexedDB.open(DB_NAME, DB_VERSION);
    req.onupgradeneeded = () => {
      const db = req.result;
      if (!db.objectStoreNames.contains(AUDIO_STORE)) {
        db.createObjectStore(AUDIO_STORE);
      }
    };
    req.onsuccess = () => resolve(req.result);
    req.onerror = () => reject(req.error);
  });
}

function idbGet(key: string): Promise<Blob | undefined> {
  return openDB().then(
    (db) =>
      new Promise((resolve, reject) => {
        const tx = db.transaction(AUDIO_STORE, "readonly");
        const store = tx.objectStore(AUDIO_STORE);
        const req = store.get(key);
        req.onsuccess = () => resolve(req.result as Blob | undefined);
        req.onerror = () => reject(req.error);
      })
  );
}

function idbSet(key: string, value: Blob) {
  return openDB().then(
    (db) =>
      new Promise<void>((resolve, reject) => {
        const tx = db.transaction(AUDIO_STORE, "readwrite");
        const store = tx.objectStore(AUDIO_STORE);
        const req = store.put(value, key);
        req.onsuccess = () => resolve();
        req.onerror = () => reject(req.error);
      })
  );
}

function idbDel(key: string) {
  return openDB().then(
    (db) =>
      new Promise<void>((resolve, reject) => {
        const tx = db.transaction(AUDIO_STORE, "readwrite");
        const store = tx.objectStore(AUDIO_STORE);
        const req = store.delete(key);
        req.onsuccess = () => resolve();
        req.onerror = () => reject(req.error);
      })
  );
}

// --- Tipi ---
interface Entry {
  id: string;
  titolo: string;
  anno?: string;
  quartiere?: string;
  indirizzo?: string;
  descrizione: string;
  immagine?: string; // URL opzionale
  audioKey?: string; // id per IndexedDB
  durataStimataMin?: number; // per l'ascolto in loco
}

// --- Utilità varie ---
const uid = () => Math.random().toString(36).slice(2) + Date.now().toString(36);

const sampleEntries: Entry[] = [
  {
    id: uid(),
    titolo: "Torre Velasca",
    anno: "1958",
    quartiere: "Centro Storico",
    indirizzo: "Piazza Velasca",
    immagine:
      "https://upload.wikimedia.org/wikipedia/commons/5/5a/Torre_Velasca%2C_Milan_-_panoramio.jpg",
    descrizione:
      "Simbolo del dopoguerra milanese, progettata dal gruppo BBPR. La sagoma a fungo rielabora in chiave moderna suggestioni medievali, in contrasto con il razionalismo ortodosso.",
    durataStimataMin: 4,
  },
  {
    id: uid(),
    titolo: "Grattacielo Pirelli (Pirellone)",
    anno: "1960",
    quartiere: "Centro Direzionale",
    indirizzo: "Piazza Duca d'Aosta",
    immagine:
      "https://upload.wikimedia.org/wikipedia/commons/3/31/Pirelli_Tower_%28Milan%29_%282019%29.jpg",
    descrizione:
      "Capolavoro dell'ingegneria italiana, Gio Ponti con Pier Luigi Nervi. Affusolato e leggero, è un manifesto dell'eleganza strutturale del boom economico.",
    durataStimataMin: 5,
  },
  {
    id: uid(),
    titolo: "QT8 e Monte Stella",
    anno: "1947–1960s",
    quartiere: "QT8",
    indirizzo: "Parco Monte Stella",
    immagine:
      "https://upload.wikimedia.org/wikipedia/commons/7/7b/Monte_Stella_%28Milano%29.jpg",
    descrizione:
      "Quartiere sperimentale della ricostruzione postbellica, promosso da Piero Bottoni. Il Monte Stella, artificiale, nasce dai detriti dei bombardamenti: paesaggio e memoria si intrecciano.",
    durataStimataMin: 6,
  },
  {
    id: uid(),
    titolo: "Casa Rustici (Terragni e Lingeri)",
    anno: "1935",
    quartiere: "Corso Sempione",
    indirizzo: "Corso Sempione 36",
    immagine:
      "https://upload.wikimedia.org/wikipedia/commons/0/05/Casa_Rustici_Milan.jpg",
    descrizione:
      "Residenza razionalista di riferimento a Milano: pilotis, vuoti loggiati, chiarezza strutturale. Una mediazione tra avanguardia e abitare borghese.",
    durataStimataMin: 4,
  },
  {
    id: uid(),
    titolo: "Stazione Centrale (rifacimento)",
    anno: "1931",
    quartiere: "Centrale",
    indirizzo: "Piazza Duca d'Aosta",
    immagine:
      "https://upload.wikimedia.org/wikipedia/commons/9/9a/Milano_Centrale_railway_station_-_front_view.jpg",
    descrizione:
      "Monumento dell'eclettismo novecentesco: monumentalità, apparato decorativo, ambizione infrastrutturale della città negli anni Trenta.",
    durataStimataMin: 5,
  },
];

function saveEntries(entries: Entry[]) {
  localStorage.setItem("milano-arch-entries", JSON.stringify(entries));
}
function loadEntries(): Entry[] {
  try {
    const raw = localStorage.getItem("milano-arch-entries");
    if (!raw) return [];
    return JSON.parse(raw) as Entry[];
  } catch (e) {
    console.error(e);
    return [];
  }
}

// --- Componenti UI minimi ---
function TextInput({ label, value, onChange, placeholder, textarea = false }: any) {
  return (
    <label className="flex flex-col gap-1 text-sm">
      <span className="font-medium text-gray-700">{label}</span>
      {textarea ? (
        <textarea
          className="rounded-2xl border p-3 focus:outline-none focus:ring"
          value={value}
          placeholder={placeholder}
          onChange={(e) => onChange(e.target.value)}
          rows={5}
        />
      ) : (
        <input
          className="rounded-2xl border p-3 focus:outline-none focus:ring"
          value={value}
          placeholder={placeholder}
          onChange={(e) => onChange(e.target.value)}
        />
      )}
    </label>
  );
}

function Button({ children, onClick, type = "button", variant = "solid", disabled = false }: any) {
  const base =
    "px-4 py-2 rounded-2xl text-sm font-medium transition shadow-sm disabled:opacity-50";
  const styles =
    variant === "solid"
      ? "bg-black text-white hover:opacity-90"
      : variant === "danger"
      ? "bg-red-600 text-white hover:opacity-90"
      : variant === "ghost"
      ? "bg-transparent hover:bg-gray-100"
      : "bg-white border hover:bg-gray-50";
  return (
    <button type={type} disabled={disabled} className={`${base} ${styles}`} onClick={onClick}>
      {children}
    </button>
  );
}

function Pill({ children }: any) {
  return <span className="rounded-full bg-gray-100 px-2.5 py-1 text-xs">{children}</span>;
}

// --- Player ---
function AudioPlayer({ entry }: { entry: Entry }) {
  const [url, setUrl] = useState<string | null>(null);
  const [loading, setLoading] = useState(false);

  useEffect(() => {
    let revoked: string | null = null;
    const run = async () => {
      if (!entry.audioKey) return;
      setLoading(true);
      const blob = await idbGet(entry.audioKey);
      setLoading(false);
      if (blob) {
        const objectUrl = URL.createObjectURL(blob);
        setUrl(objectUrl);
        revoked = objectUrl;
      } else {
        setUrl(null);
      }
    };
    run();
    return () => {
      if (revoked) URL.revokeObjectURL(revoked);
    };
  }, [entry.audioKey]);

  if (!entry.audioKey) return <div className="text-sm text-gray-500">Nessun MP3 allegato.</div>;
  if (loading) return <div className="text-sm text-gray-500">Caricamento audio…</div>;
  if (!url) return <div className="text-sm text-red-600">Audio non trovato (IDB svuotato?).</div>;

  return (
    <audio className="w-full" src={url} controls preload="none" />
  );
}

// --- Modale semplice ---
function Modal({ open, onClose, title, children, footer }: any) {
  if (!open) return null;
  return (
    <div className="fixed inset-0 z-50 flex items-center justify-center">
      <div className="absolute inset-0 bg-black/40" onClick={onClose} />
      <div className="relative z-10 w-full max-w-3xl rounded-2xl bg-white p-6 shadow-xl">
        <div className="mb-4 flex items-start justify-between gap-4">
          <h3 className="text-lg font-semibold">{title}</h3>
          <button className="text-gray-500 hover:text-black" onClick={onClose}>
            ✕
          </button>
        </div>
        <div className="max-h-[70vh] overflow-y-auto pr-1">{children}</div>
        {footer && <div className="mt-6 flex justify-end gap-2">{footer}</div>}
      </div>
    </div>
  );
}

// --- Componente principale ---
export default function MilanoArchAudioGuide() {
  const [entries, setEntries] = useState<Entry[]>([]);
  const [query, setQuery] = useState("");
  const [editing, setEditing] = useState<Entry | null>(null);
  const [modalOpen, setModalOpen] = useState(false);
  const [importOpen, setImportOpen] = useState(false);
  const fileRef = useRef<HTMLInputElement>(null);

  useEffect(() => {
    let data = loadEntries();
    if (data.length === 0) {
      data = sampleEntries;
      saveEntries(data);
    }
    setEntries(data);
  }, []);

  useEffect(() => {
    saveEntries(entries);
  }, [entries]);

  const filtered = useMemo(() => {
    const q = query.trim().toLowerCase();
    if (!q) return entries;
    return entries.filter((e) =>
      [e.titolo, e.anno, e.quartiere, e.indirizzo, e.descrizione]
        .filter(Boolean)
        .some((f) => (f as string).toLowerCase().includes(q))
    );
  }, [entries, query]);

  function startNew() {
    setEditing({ id: uid(), titolo: "", descrizione: "" });
    setModalOpen(true);
  }

  function editEntry(e: Entry) {
    setEditing({ ...e });
    setModalOpen(true);
  }

  function removeEntry(id: string) {
    const e = entries.find((x) => x.id === id);
    if (!e) return;
    if (confirm(`Eliminare “${e.titolo}”?`)) {
      setEntries((list) => list.filter((x) => x.id !== id));
      if (e.audioKey) idbDel(e.audioKey);
    }
  }

  async function attachAudio(file: File, toId: string) {
    if (!file.type.includes("audio")) {
      alert("Seleziona un file audio (mp3 consigliato).");
      return;
    }
    const key = `audio-${toId}`;
    await idbSet(key, file);
    setEntries((list) => list.map((e) => (e.id === toId ? { ...e, audioKey: key } : e)));
  }

  function EntryForm({ model, onCancel, onSave }: { model: Entry; onCancel: () => void; onSave: (e: Entry) => void }) {
    const [m, setM] = useState<Entry>(model);
    return (
      <div className="flex flex-col gap-4">
        <div className="grid grid-cols-1 gap-4 md:grid-cols-2">
          <TextInput label="Titolo" value={m.titolo} onChange={(v: string) => setM({ ...m, titolo: v })} />
          <TextInput label="Anno/Periodo" value={m.anno || ""} onChange={(v: string) => setM({ ...m, anno: v })} />
          <TextInput label="Quartiere" value={m.quartiere || ""} onChange={(v: string) => setM({ ...m, quartiere: v })} />
          <TextInput label="Indirizzo" value={m.indirizzo || ""} onChange={(v: string) => setM({ ...m, indirizzo: v })} />
          <TextInput label="URL immagine (opzionale)" value={m.immagine || ""} onChange={(v: string) => setM({ ...m, immagine: v })} />
          <TextInput label="Durata visita (min)" value={m.durataStimataMin || ""} onChange={(v: string) => setM({ ...m, durataStimataMin: Number(v) || undefined })} />
        </div>
        <TextInput label="Descrizione" textarea value={m.descrizione} onChange={(v: string) => setM({ ...m, descrizione: v })} />
        <div className="flex items-center justify-between gap-2">
          <div className="flex gap-2">
            <Button variant="ghost" onClick={onCancel}>Annulla</Button>
            <Button onClick={() => onSave(m)} disabled={!m.titolo || !m.descrizione}>Salva</Button>
          </div>
          <div className="text-xs text-gray-500">
            Suggerimento: genera l'MP3 con un servizio TTS esterno e allegalo dopo il salvataggio.
          </div>
        </div>
      </div>
    );
  }

  async function exportJSON(withAudio: boolean) {
    const payload: any = { version: 1, when: new Date().toISOString(), entries: [] as any[] };
    for (const e of entries) {
      const base: any = { ...e };
      if (withAudio && e.audioKey) {
        const blob = await idbGet(e.audioKey);
        if (blob) {
          const arr = await blob.arrayBuffer();
          const b64 = btoa(String.fromCharCode(...new Uint8Array(arr)));
          base._audioBase64 = `data:${blob.type || "audio/mpeg"};base64,${b64}`;
        }
      }
      payload.entries.push(base);
    }
    const file = new Blob([JSON.stringify(payload, null, 2)], { type: "application/json" });
    const url = URL.createObjectURL(file);
    const a = document.createElement("a");
    a.href = url;
    a.download = withAudio ? "audioguida-milano-con-audio.json" : "audioguida-milano.json";
    document.body.appendChild(a);
    a.click();
    a.remove();
    URL.revokeObjectURL(url);
  }

  async function handleImport(file: File) {
    try {
      const text = await file.text();
      const data = JSON.parse(text);
      if (!data || !Array.isArray(data.entries)) throw new Error("formato non valido");
      const restored: Entry[] = [];
      for (const raw of data.entries) {
        const { _audioBase64, ...meta } = raw;
        const e: Entry = meta;
        if (!e.id) e.id = uid();
        if (_audioBase64 && typeof _audioBase64 === "string") {
          const res = await fetch(_audioBase64);
          const blob = await res.blob();
          const key = `audio-${e.id}`;
          await idbSet(key, blob);
          e.audioKey = key;
        }
        restored.push(e);
      }
      setEntries(restored);
      setImportOpen(false);
      alert("Import completato");
    } catch (err: any) {
      alert("Import fallito: " + err?.message);
    }
  }

  return (
    <div className="mx-auto max-w-6xl p-4 md:p-8">
      <header className="mb-6 flex flex-col items-start justify-between gap-4 md:flex-row md:items-center">
        <div>
          <h1 className="text-2xl font-bold">Audioguida – Architettura a Milano (XX secolo)</h1>
          <p className="text-sm text-gray-600">Crea voci, allega MP3 (TTS) e riproduci in loco. Tutto resta sul tuo dispositivo.</p>
        </div>
        <div className="flex flex-wrap gap-2">
          <Button onClick={startNew}>Nuova voce</Button>
          <Button variant="outline" onClick={() => exportJSON(false)}>Esporta (senza audio)</Button>
          <Button variant="outline" onClick={() => exportJSON(true)}>Esporta (con audio)</Button>
          <Button variant="ghost" onClick={() => setImportOpen(true)}>Importa</Button>
        </div>
      </header>

      <div className="mb-4 flex items-center gap-2">
        <input
          value={query}
          onChange={(e) => setQuery(e.target.value)}
          placeholder="Cerca per titolo, anno, quartiere, descrizione…"
          className="w-full rounded-2xl border p-3 focus:outline-none focus:ring"
        />
        <Pill>{filtered.length} voci</Pill>
      </div>

      {filtered.length === 0 ? (
        <div className="rounded-2xl border p-8 text-center text-gray-500">Nessuna voce. Crea la prima con “Nuova voce”.</div>
      ) : (
        <div className="grid grid-cols-1 gap-4 md:grid-cols-2">
          {filtered.map((e) => (
            <article key={e.id} className="rounded-2xl border p-4 shadow-sm">
              <div className="mb-3 flex items-start justify-between gap-2">
                <h2 className="text-lg font-semibold">{e.titolo}</h2>
                <div className="flex gap-2">
                  <Button variant="ghost" onClick={() => editEntry(e)}>Modifica</Button>
                  <Button variant="danger" onClick={() => removeEntry(e.id)}>Elimina</Button>
                </div>
              </div>
              <div className="mb-3 flex flex-wrap items-center gap-2 text-sm text-gray-600">
                {e.anno && <Pill>{e.anno}</Pill>}
                {e.quartiere && <Pill>{e.quartiere}</Pill>}
                {e.durataStimataMin ? <Pill>{e.durataStimataMin} min</Pill> : null}
              </div>
              {e.immagine && (
                <img src={e.immagine} alt={e.titolo} className="mb-3 aspect-video w-full rounded-xl object-cover" />
              )}
              {e.indirizzo && (
                <div className="mb-2 text-sm text-gray-700"><strong>Indirizzo:</strong> {e.indirizzo}</div>
              )}
              <p className="mb-4 text-sm leading-relaxed text-gray-800 whitespace-pre-wrap">{e.descrizione}</p>

              <div className="mb-3">
                <AudioPlayer entry={e} />
              </div>

              <div className="flex items-center justify-between gap-2">
                <div className="text-xs text-gray-500">Allega MP3 (TTS del testo)</div>
                <div className="flex items-center gap-2">
                  <input
                    ref={fileRef}
                    onChange={(ev) => {
                      const f = ev.target.files?.[0];
                      if (f) attachAudio(f, e.id);
                      ev.currentTarget.value = "";
                    }}
                    type="file"
                    accept="audio/mpeg,audio/mp3"
                    className="hidden"
                  />
                  <Button variant="outline" onClick={() => fileRef.current?.click()}>Carica MP3</Button>
                </div>
              </div>
            </article>
          ))}
        </div>
      )}

      {/* Modale editor */}
      <Modal
        open={modalOpen}
        onClose={() => setModalOpen(false)}
        title={editing?.id ? (editing?.titolo ? `Modifica: ${editing.titolo}` : "Nuova voce") : ""}
        footer={null}
      >
        {editing && (
          <EntryForm
            model={editing}
            onCancel={() => setModalOpen(false)}
            onSave={(e) => {
              setEntries((list) => {
                const exists = list.some((x) => x.id === e.id);
                return exists ? list.map((x) => (x.id === e.id ? { ...x, ...e } : x)) : [e, ...list];
              });
              setModalOpen(false);
            }}
          />
        )}
      </Modal>

      {/* Import */}
      <Modal open={importOpen} onClose={() => setImportOpen(false)} title="Importa guida" footer={null}>
        <p className="mb-4 text-sm text-gray-600">
          Seleziona un file JSON esportato da questa app. Se contiene audio incorporato, verrà ripristinato in locale.
        </p>
        <input
          type="file"
          accept="application/json"
          onChange={(e) => {
            const f = e.target.files?.[0];
            if (f) handleImport(f);
          }}
        />
      </Modal>

      <footer className="mt-10 text-center text-xs text-gray-500">
        Tutti i dati restano nel browser (LocalStorage + IndexedDB). Per condividere con una classe, usa “Esporta” e distribuisci il JSON.
      </footer>
    </div>
  );
}
